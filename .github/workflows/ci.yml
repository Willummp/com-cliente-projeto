name: Pipeline CI/CD Completo (TP5)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # JOB 1: SeguranÃ§a, Build e Testes
  security-build-test:
    name: ðŸ›¡ï¸ SeguranÃ§a e Qualidade
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    
    steps:
      - name: Checkout do CÃ³digo
        uses: actions/checkout@v4

      - name: Configurar Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # --- CODEQL (Substitui o OWASP) ---
      - name: ðŸ›¡ï¸ Inicializar CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java

      # O Maven agora roda LIMPO, sem tentar baixar o NVD
      - name: ðŸ—ï¸ Build e Testes UnitÃ¡rios
        run: mvn clean verify
      
      - name: ðŸ•µï¸â€â™‚ï¸ Realizar AnÃ¡lise CodeQL
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:java"
      # ---------------------------------
      
      - name: ðŸ“ Gerar Log de Testes
        if: always()
        run: |
          echo "=== RESUMO DA EXECUÃ‡ÃƒO ===" > resumo_execucao.log
          echo "Data: $(date)" >> resumo_execucao.log
          cat resumo_execucao.log

      - name: ðŸ“¤ Upload RelatÃ³rio JaCoCo
        uses: actions/upload-artifact@v4
        with:
          name: relatorio-cobertura
          path: target/site/jacoco/

      - name: ðŸ“¦ Upload do JAR da AplicaÃ§Ã£o
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: target/*.jar

      - name: ðŸ“Š Resumo do Job
        run: |
          echo "### ðŸš€ Resultado do Build" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Testes executados com sucesso" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ›¡ï¸ AnÃ¡lise CodeQL concluÃ­da" >> $GITHUB_STEP_SUMMARY

  # JOB 2: Deploy em HomologaÃ§Ã£o
  deploy-homolog:
    name: ðŸš€ Deploy HomologaÃ§Ã£o
    needs: security-build-test
    runs-on: ubuntu-latest
    
    steps:
      - name: Baixar Artefato
        uses: actions/download-artifact@v4
        with:
          name: app-jar
      - name: Simular Deploy
        run: echo "AplicaÃ§Ã£o implantada com sucesso em HomologaÃ§Ã£o!"
      - name: ðŸ§ª Smoke Test
        run: echo "Health Check OK!"

  # JOB 3: Testes E2E PÃ³s-Deploy (Selenium)
  testes-e2e-pos-deploy:
    name: ðŸŒ Testes E2E PÃ³s-Deploy
    needs: deploy-homolog
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout do CÃ³digo
        uses: actions/checkout@v4
      
      - name: Configurar Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: ðŸŒ Executar Testes E2E (Selenium)
        run: mvn test -Dtest=*E2ETest
      
      - name: ðŸ“Š Resumo dos Testes E2E
        if: always()
        run: |
          echo "### ðŸŒ Resultado dos Testes E2E" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Testes Selenium executados com sucesso" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ CenÃ¡rios validados:" >> $GITHUB_STEP_SUMMARY
          echo "- CriaÃ§Ã£o de eventos" >> $GITHUB_STEP_SUMMARY
          echo "- ValidaÃ§Ã£o de campos obrigatÃ³rios" >> $GITHUB_STEP_SUMMARY
          echo "- Regras de negÃ³cio (nome duplicado)" >> $GITHUB_STEP_SUMMARY
          echo "- Fluxo completo de CRUD" >> $GITHUB_STEP_SUMMARY

  # JOB 4: Deploy em ProduÃ§Ã£o
  deploy-prod:
    name: ðŸš€ Deploy ProduÃ§Ã£o
    needs: testes-e2e-pos-deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: Baixar Artefato
        uses: actions/download-artifact@v4
        with:
          name: app-jar
      - name: Simular Deploy
        run: echo "âœ… Deploy em ProduÃ§Ã£o concluÃ­do!"
      - name: ðŸ”” NotificaÃ§Ã£o de Deploy
        run: echo "::notice::Deploy em produÃ§Ã£o realizado com sucesso!"